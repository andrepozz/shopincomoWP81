<!DOCTYPE html>
<html>
<head>
	<title>Page Title</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, target-densitydpi=medium-dpi, user-scalable=0" />
	<script type="text/javascript" src="cordova.js"></script>
	<link rel="stylesheet" href="css/themes/shopincomo.min.css" />
	<link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
	<link rel="stylesheet" href="css/jquery.mobile.structure-1.4.2.min.css" />
	<link rel="stylesheet" href="css/template.css" />
	<script src="js/jquery-1.11.0.min.js"></script>
	<script src="js/jquery.mobile-1.4.2.min.js"></script>	
	<script src="js/highcharts.js"></script>
	<link rel="stylesheet" href="css/leaflet.css" />
	<link rel="stylesheet" href="css/leaflet.usermarker.css" />
	<link rel="stylesheet" href="css/vetrina.css" />
	<script src="js/leaflet.js"></script>
	<script src="js/leaflet.usermarker.js"></script>
	<script src="js/function_checkConnection.js"></script>
</head>
<body>

<!-- PAGE #index -->
<div data-role="page" id="index">

	<!-- /HEADER -->
	<div data-role="header" data-position="fixed" data-tap-toggle="false">
	<h1></h1>
	</div>
	<!-- /HEADER -->
	
	<!-- CONTENT -->
	<div role="main" class="ui-content" >
	
	<script>   
	$( "#index" ).on( "pageshow", function() {	
	
	document.addEventListener("backbutton", onBackKeyDown, false);
		
		function onBackKeyDown(e) {
		e.preventDefault();
		}
	
	$(".headerUpdateDisponibili").html(""+window.localStorage.getItem("aggiornamentiDisponibili")+"");
	$(".descrizioneUpdateDisponibili").html(""+window.localStorage.getItem("aggiornamentiPopupDescrizione")+"");
	$(".buttonUpdateDisponibili").html(""+window.localStorage.getItem("aggiorna")+"");
	$(".closePopupUpdateDisponibili").html(""+window.localStorage.getItem("chiudi")+"");
		
	var lingua = window.localStorage.getItem("lingua");
	if (lingua == null) {
	
			document.addEventListener("deviceready", function(){
			alert("device is ready");
			if (device.platform === "WinCE" || device.platform === "Win32NT") {
			$( "#setupApplicazione" ).popup("open");
			}
			else{
			$.mobile.changePage( "#lingue", { allowSamePageTransition:true, transition: "slide" } );
			}
			
			}, false);
			
	}
	else
	{
	
	//CHECK GEOLOCATION
	
	var watchID = null;
	
	document.addEventListener("deviceready", function(){
	
		
	
		if (device.platform === "iOS") {
			var options = { maximumAge: 1500, timeout: 10000, enableHighAccuracy: true };
			watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
		}
		
		if (device.platform === "Android") {
			var options = { maximumAge: 1500, timeout: 10000, enableHighAccuracy: true };
			navigator.geolocation.getCurrentPosition(onSuccess, onError, options);
		}
		
		if (device.platform === "WinCE" || device.platform === "Win32NT") {
			var options = { maximumAge: 1500, timeout: 30000, enableHighAccuracy: false };
			watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
		}
			
	}, false);
	

	if(window.sessionStorage.getItem("userLatitude") == null)
	{
	
	$.mobile.loading( "show", {
            text: ""+window.localStorage.getItem("localizzando")+"",
            textVisible: true,
            theme: "b",
            textonly: false
	});
	
	}
	
	function onSuccess(position) {
	var userLatitude = position.coords.latitude;
    var userLongitude = position.coords.longitude;
	var userAccuracy = position.coords.accuracy;
	
	window.sessionStorage.setItem("userLatitude", userLatitude);
	window.sessionStorage.setItem("userLongitude", userLongitude);
	window.sessionStorage.setItem("userAccuracy", userAccuracy);
	var	connectionStatus = navigator.onLine ? 'online' : 'offline';
	if (connectionStatus == "online" && window.sessionStorage.getItem("doneCheckUpdates") != "si")
	{
		checkUpdates();
	}
	else{
		$.mobile.loading( "hide" );
	}
    }
	
	function onError(error) {
		
		if (device.platform === "iOS" || device.platform === "Android") {
			navigator.geolocation.getCurrentPosition(onSuccess, onErrorTimeout,{maximumAge: 1500, timeout: 20000, enableHighAccuracy : false});
		}
		
		if (device.platform === "WinCE" || device.platform === "Win32NT") {			
				console.log("Geolocation Error Timeout");
				alert(""+window.localStorage.getItem("noLocalizzazione")+"");
				var userLatitude = "45.80806";
				var userLongitude = "9.08518";
				var userAccuracy = "0";
	
			window.sessionStorage.setItem("userLatitude", userLatitude);
			window.sessionStorage.setItem("userLongitude", userLongitude);
			window.sessionStorage.setItem("userAccuracy", userAccuracy);
			var	connectionStatus = navigator.onLine ? 'online' : 'offline';
			if (connectionStatus == "online" && window.sessionStorage.getItem("doneCheckUpdates") != "si")
			{
				checkUpdates();
			}
			else{
			$.mobile.loading( "hide" );
			}
		}
		
    }
	
	function onErrorTimeout(error) {
		console.log("Geolocation Error Timeout");
		alert(""+window.localStorage.getItem("noLocalizzazione")+"");
		var userLatitude = "45.80806";
	    var userLongitude = "9.08518";
		var userAccuracy = "0";
	
		window.sessionStorage.setItem("userLatitude", userLatitude);
		window.sessionStorage.setItem("userLongitude", userLongitude);
		window.sessionStorage.setItem("userAccuracy", userAccuracy);
		var	connectionStatus = navigator.onLine ? 'online' : 'offline';
		if (connectionStatus == "online" && window.sessionStorage.getItem("doneCheckUpdates") != "si")
		{
			checkUpdates();
		}
		else{
			$.mobile.loading( "hide" );
		}
    }
	
	// SET MENU
	var codLinguaMenu = window.localStorage.getItem("codLingua");
	
	if(codLinguaMenu == "it" || codLinguaMenu == null){
	estensioneImmagine = "it";
	}
	else{
	estensioneImmagine = "en";
	}
	
	$("div#rigaBorsa_1").html("");
	$("div#rigaBorsa_2").html("");
	$("div#rigaBorsa_1").append($("<div class='blocco_sx'><a href='eserciziVicini.html' rel='external' data-transition='slide'><img src='img/ricercaDistanza_"+estensioneImmagine+".png'></a></div><div class='blocco_dx'><a href='categorie.html' rel='external' data-transition='slide'><img src='img/ricercaCategoria_"+estensioneImmagine+".png'></a></div>"));
	$("div#rigaBorsa_2").append($("<div class='blocco_sx'><a href='nomeEsercizi.html' rel='external' data-transition='slide'><img src='img/ricercaNegozio_"+estensioneImmagine+".png'></a></div><div class='blocco_dx'><a href='brandEsercizi.html' rel='external' data-transition='slide'><img src='img/ricercaBrand_"+estensioneImmagine+".png'></a></div>"));
	
	document.addEventListener("deviceready", function(){
	
	if (device.platform === "Android" || device.platform === "iOS") {
	$('#index').append('<div data-role="footer" data-position="fixed" data-tap-toggle="false"><div data-role="navbar"><ul><li><a href="#" class="qrCode"><img src="img/qrcode.png"></a></li><li><a href="opzioni.html" rel="external" data-transition="slide"><img src="img/opzioni.png"></a></li><li><a href="#credits" data-transition="flip"><img src="img/info.png"></a></li></ul></div></div>').trigger( "create" ); 	
	}
	if (device.platform === "WinCE" || device.platform === "Win32NT") {	
	$('#index').append('<div data-role="footer" data-position="fixed" data-tap-toggle="false"><div data-role="navbar"><ul><li><a href="opzioni.html" rel="external" data-transition="slide"><img src="img/opzioni.png"></a></li><li><a href="#credits" data-transition="flip"><img src="img/info.png"></a></li></ul></div></div>').trigger( "create" );
	
	}
	}, false);

	
	}
	
	});
	
	function checkUpdates(){
	var	connectionStatus = navigator.onLine ? 'online' : 'offline';
	if (connectionStatus == "online" && window.sessionStorage.getItem("doneCheckUpdates") != "si")
	{
		
		timeoutUpdate();
		
		$.mobile.loading( "show", {
            text: "Check Updates",
            textVisible: true,
            theme: "a",
            textonly: false
		});
	
	//CHECK ESISTENZA FILE DI SISTEMA
		
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
			
			
			fileSystem.root.getDirectory("ShopInComo", {create: true, exclusive: false}, onGetDirectorySuccess, onGetDirectoryFail);

				function onGetDirectorySuccess(dirEntry){
								
						if (device.platform === "Android") {
							onSetMetadataDirectorySuccess(dirEntry);
						}
						
						if (device.platform === "WinCE" || device.platform === "Win32NT") {
							onSetMetadataDirectorySuccess(dirEntry);
						}
								
						if (device.platform === "iOS") {
							dirEntry.setMetadata(onSetMetadataDirectorySuccess(dirEntry), onSetMetadataDirectoryFail, { "com.apple.MobileBackup": 1});
						}
								
				} // close onGetDirectorySuccess

				function onGetDirectoryFail(){

				console.log("Fail to get directory");

				} // close onGetDirectoryFail

				function onSetMetadataDirectorySuccess(dirEntry){
				

				// Get a directory reader
				var directoryReader = dirEntry.createReader();
				
				// Get a list of all the entries in the directory
				directoryReader.readEntries(success,fail);
				
				function success(entries) {
				
					var fileSistema = ["brandEsercizi.js","brand.js","categorie.js","nomeEsercizi.js","position.js","esercizi","categorie"];		
					
					var fileSistemaMancanti = [];
										
					for (var i=0;i<fileSistema.length;i++) {
						rv = false;
							for (var j=0;j<entries.length;j++) {
								rv = rv ||  fileSistema[i] == entries[j].name;
							}
							if(!rv)
							{
								fileSistemaMancanti.push(fileSistema[i]);
							}
					}

					checkCategorie(fileSistemaMancanti);
										
				}

				function fail(error) {
					console.log("Failed to list directory contents: " + error.code);
				}

				} // close onSetMetadataDirectorySuccess

				function onSetMetadataDirectoryFail(){

				console.log("Fail to set metadata directory");

				} // close onSetMetadataDirectoryFail
			
		}); // end of window.requestFileSystem
		
	// CHECK ESISTENZA CATEGORIE

	function checkCategorie(fileSistemaMancanti){
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
			fileSystem.root.getDirectory("ShopInComo/categorie", {create: true, exclusive: false}, onGetDirectorySuccess, onGetDirectoryFail);

				function onGetDirectorySuccess(dirEntry){
								
						if (device.platform === "Android") {
							onSetMetadataDirectorySuccess(dirEntry);
						}
						
						if (device.platform === "WinCE" || device.platform === "Win32NT") {
							onSetMetadataDirectorySuccess(dirEntry);
						}
								
						if (device.platform === "iOS") {
							dirEntry.setMetadata(onSetMetadataDirectorySuccess(dirEntry), onSetMetadataDirectoryFail, { "com.apple.MobileBackup": 1});
						}
								
				} // close onGetDirectorySuccess

				function onGetDirectoryFail(){

				console.log("Fail to get directory");

				} // close onGetDirectoryFail

				function onSetMetadataDirectorySuccess(dirEntry){

				// Get a directory reader
				var directoryReader = dirEntry.createReader();

				// Get a list of all the entries in the directory
				directoryReader.readEntries(success,fail);
				
				function success(entries) {
					var path = window.localStorage.getItem("pathSD");
					var jsonPath = path + "/categorie.js";
					var fileCategorieMancanti = [];		
					$.getJSON(jsonPath, function( listaCategorie ) {
						var fileCategorie = [];
						$.each(listaCategorie, function(index, info) {
						
							fileCategorie.push({
							jsonNameCategorie: info.jsonName
							});

						
						});
					
					for (var i=0;i<fileCategorie.length;i++) {
					rv = false;
					for (var j=0;j<entries.length;j++) {
					rv = rv ||  fileCategorie[i].jsonNameCategorie == entries[j].name.substring(0, entries[j].name.length - 3);
					}
					if(!rv)
					{
					fileCategorieMancanti.push(fileCategorie[i].jsonNameCategorie);
					}
					}
					//eserciziUpdate(fileCategorieMancanti);
					checkVetrine(fileSistemaMancanti, fileCategorieMancanti);
					//window.sessionStorage.setItem("fileEserciziMancanti", JSON.stringify(fileEserciziMancanti));
					});
					
				}

				function fail(error) {
					console.log("Failed to list directory contents: " + error.code);
				}

				} // close onSetMetadataDirectorySuccess

				function onSetMetadataDirectoryFail(){

				console.log("Fail to set metadata directory");

				} // close onSetMetadataDirectoryFail
			
		}); // end of window.requestFileSystem
		
	} // END FUNCTION CHECK CATEGORIE

	// CHECK ESISTENZA VETRINE
	function checkVetrine(fileSistemaMancanti, fileCategorieMancanti) {	
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
			
			fileSystem.root.getDirectory("ShopInComo/esercizi", {create: true, exclusive: false}, onGetDirectorySuccess, onGetDirectoryFail);

				function onGetDirectorySuccess(dirEntry){

								
						if (device.platform === "Android") {
							onSetMetadataDirectorySuccess(dirEntry);
						}
						
						if (device.platform === "WinCE" || device.platform === "Win32NT") {
							onSetMetadataDirectorySuccess(dirEntry);
						}
								
						if (device.platform === "iOS") {
							dirEntry.setMetadata(onSetMetadataDirectorySuccess(dirEntry), onSetMetadataDirectoryFail, { "com.apple.MobileBackup": 1});
						}
								
				} // close onGetDirectorySuccess

				function onGetDirectoryFail(){

				console.log("Fail to get directory");

				} // close onGetDirectoryFail

				function onSetMetadataDirectorySuccess(dirEntry){
			
				// Get a directory reader
				var directoryReader = dirEntry.createReader();

				// Get a list of all the entries in the directory
				directoryReader.readEntries(success,fail);
				
				function success(entries) {
					var path = window.localStorage.getItem("pathSD");
					var jsonPath = path + "/nomeEsercizi.js";

					var fileEserciziMancanti = [];		
					$.getJSON(jsonPath, function( listaEsercizi ) {
						var idEsercizi = [];
						$.each(listaEsercizi, function(index, info) {
						
							idEsercizi.push({
							idEsercizio: info.idEsercizio
							});

						
						});
					
					for (var i=0;i<idEsercizi.length;i++) {
					rv = false;
					for (var j=0;j<entries.length;j++) {
					rv = rv ||  parseInt(idEsercizi[i].idEsercizio) == parseInt(entries[j].name.substring(0, entries[j].name.length - 3));
					}
					if(!rv)
					{
					fileEserciziMancanti.push(idEsercizi[i].idEsercizio);
					}
					}
					eserciziUpdate(fileSistemaMancanti, fileCategorieMancanti, fileEserciziMancanti);
					window.sessionStorage.setItem("fileEserciziMancanti", JSON.stringify(fileEserciziMancanti));
					});
					
				}

				function fail(error) {
					console.log("Failed to list directory contents: " + error.code);
				}

				} // close onSetMetadataDirectorySuccess

				function onSetMetadataDirectoryFail(){

				console.log("Fail to set metadata directory");

				} // close onSetMetadataDirectoryFail
			
		}); // end of window.requestFileSystem
	
	} // END FUNCTION CHECK VETRINE
		
	function eserciziUpdate(fileSistemaMancanti, fileCategorieMancanti, fileEserciziMancanti){

		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
			
			fileSystem.root.getDirectory("ShopInComo", {create: true, exclusive: false}, onGetDirectorySuccess, onGetDirectoryFail);


				function onGetDirectorySuccess(dirEntry){

					//MEMORIZZA PATH
					var directory = dirEntry.fullPath;
								
						if (device.platform === "Android") {
							onSetMetadataDirectorySuccess(dirEntry);
						}
						
						if (device.platform === "WinCE" || device.platform === "Win32NT") {
							onSetMetadataDirectorySuccess(dirEntry);
						}
								
						if (device.platform === "iOS") {
							dirEntry.setMetadata(onSetMetadataDirectorySuccess(dirEntry), onSetMetadataDirectoryFail, { "com.apple.MobileBackup": 1});
						}
								
				} // close onGetDirectorySuccess

				function onGetDirectoryFail(){

				console.log("Fail to get directory");

				} // close onGetDirectoryFail

				function onSetMetadataDirectorySuccess(dirEntry){
				
				dirEntry.getFile("categorie.js", {create: true, exclusive: false}, onGetFileSuccess, onGetFileFail);

				} // close onSetMetadataDirectorySuccess

				function onSetMetadataDirectoryFail(){

				console.log("Fail to set metadata directory");

				} // close onSetMetadataDirectoryFail


				function onGetFileSuccess(fileEntry){

					if (device.platform === "iOS") {
						fileEntry.setMetadata(onSetMetadataFileSuccess(fileEntry), onSetMetadataFileFail, { "com.apple.MobileBackup": 1});
					}
					
					if (device.platform === "WinCE" || device.platform === "Win32NT") {
							onSetMetadataFileSuccess(fileEntry);
					}

					if (device.platform === "Android") {
						onSetMetadataFileSuccess(fileEntry);
					}

				} // close onGetFileSuccess

				function onGetFileFail(){

					console.log("Fail to get file");

				} // close onGetFileFail

				function onSetMetadataFileSuccess(fileEntry){
									
					fileEntry.getMetadata(function(metadata) {
					
					if (device.platform === "iOS" || device.platform === "Android") {
						var dataDownload = Date.parse(metadata.modificationTime) / 1000;
					}
					
					if (device.platform === "WinCE" || device.platform === "Win32NT") {
						var dataDownload = Math.round(localStorage.getItem("lastDownload")/ 1000);
					}
					
					
					localStorage.setItem("dataDownload", dataDownload );
					
					var urlJSON = "http://shopincomo.comune.como.it/ccn20/JSONidEserciziUpdate.php?language="+localStorage.getItem("codLingua")+"&dataDownload="+dataDownload;
						
						$.ajax({
							url: "http://shopincomo.comune.como.it/ccn20/JSONidEserciziUpdate.php",
							type: "GET",
							dataType: "json",
							data: {language: localStorage.getItem("codLingua"), dataDownload: dataDownload},
							timeout: 15000
						}).done(function(response){
							if (response.length == 0 && fileEserciziMancanti.length == 0 && fileSistemaMancanti.length == 0 && fileCategorieMancanti.length == 0) {
								localStorage.setItem("numeroAggiornamenti", 0);
								//alert("NO aggiornamenti disponibili");
								//$("p.countUpdates").html(""+window.localStorage.getItem("statusDatabase")+"");
								$.mobile.loading( "hide" );
							}
							else {
								numeroAggiornamenti = response.length + fileEserciziMancanti.length + fileSistemaMancanti.length + fileCategorieMancanti.length;
								localStorage.setItem("numeroAggiornamenti", numeroAggiornamenti);
								$( "#updateDisponibili" ).popup("open");
								$.mobile.loading( "hide" );
							}
						}).fail(function(jqXHR, textStatus){
							if(textStatus == 'timeout')
							{     
								if (fileEserciziMancanti.length == 0 && fileSistemaMancanti.length == 0 && fileCategorieMancanti.length == 0) {
								$.mobile.loading( "hide" );
								}
								else {
									$( "#updateDisponibili" ).popup("open");
									$.mobile.loading( "hide" );
								}
							}
							else
							{
								if (fileEserciziMancanti.length == 0 && fileSistemaMancanti.length == 0 && fileCategorieMancanti.length == 0) {
								$.mobile.loading( "hide" );
								}
								else {
									$( "#updateDisponibili" ).popup("open");
									$.mobile.loading( "hide" );
								}
							}
						});
					
					}); // end fileEntry.getMetadata
				}
					 
				function onSetMetadataFileFail(){

					console.log("Fail to set metadata file");

				} // close onSetMetadataFileFail
			
		}); // end of window.requestFileSystem
		
	} // end of eserciziUpdate

	var doneCheckUpdates = "si"
	window.sessionStorage.setItem("doneCheckUpdates", doneCheckUpdates);
	}
	}
	//FINE CHECK UPDATES
	
	function timeoutUpdate()
	{
		setTimeout(function(){
		$.mobile.loading( "hide" );
		},15000);
	}
	
	//FINE TIMEOUT UPDATES
	

	
	$(document).on("click", 'a.closePopupUpdateDisponibili', function(){
		
		$( "#updateDisponibili" ).popup("close");
		
	});
		
	</script>

	<div id="manicoBorsa">
	<img src="img/manico.png">
	</div>
	<div id="rigaBorsa_1">
	</div>
	<div id="rigaBorsa_2">
	</div>
	
	<div data-role="popup" id="setupApplicazione" data-dismissible="false" data-history="false">
	<p class="headersetupApplicazione">Warning</p>
    <p class="descrizionesetupApplicazione">Setup Applicazione Necessario / Application Setup</p>
	<a href="#lingue" class="ui-btn buttonsetupApplicazione">SETUP</a>
	</div>
	
	
	<div data-role="popup" id="updateDisponibili" data-dismissible="false" data-history="false">
	<p class="headerUpdateDisponibili"></p>
    <p class="descrizioneUpdateDisponibili"></p>
	<a href="opzioni.html" rel="external" class="ui-btn buttonUpdateDisponibili">Update</a>
	<a href="#" class="ui-btn closePopupUpdateDisponibili"></a>
	</div>
	
	</div>
	<!-- /CONTENT -->

	<!-- FOOTER -->
	<!-- /FOOTER -->
	
</div><!-- /PAGE #index -->
</body>
</html>